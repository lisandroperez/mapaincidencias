rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Función Auxiliar ---
    // Esta función nos permite obtener el rol de un usuario desde la colección 'users'.
    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }

    // --- Reglas para la Colección 'users' ---
    // Aquí se guardarán los roles. Solo los administradores podrán modificarlos.
    match /users/{userId} {
      // Un usuario puede leer su propio perfil.
      allow get: if request.auth.uid == userId;
      // Solo los admins pueden leer, crear, actualizar o borrar los perfiles de usuario.
      allow list, write: if request.auth != null && getUserRole(request.auth.uid) == 'admin';
    }

    // --- Reglas para la Colección 'markers' ---
    // Control de acceso a los marcadores basado en roles.
    match /markers/{markerId} {
      // Cualquiera puede leer los marcadores.
      allow read: if true;

      // Para CREAR un marcador, el usuario debe estar autenticado y ser 'admin' o 'editor'.
      allow create: if request.auth != null && (getUserRole(request.auth.uid) == 'admin' || getUserRole(request.auth.uid) == 'editor');

      // Para ACTUALIZAR o BORRAR:
      // - El usuario debe ser 'admin'.
      // - O, el usuario debe ser 'editor' Y ser el creador del marcador.
      allow update, delete: if request.auth != null &&
                              (getUserRole(request.auth.uid) == 'admin' ||
                               (getUserRole(request.auth.uid) == 'editor' && resource.data.createdBy == request.auth.uid));
    }
  }
}
                  
