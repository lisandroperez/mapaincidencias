<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mapa Interactivo de Yerba Buena Defensa Civil</title>
  
  <!-- Estilos de Leaflet y Font Awesome -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
    /* --- ESTILOS GENERALES --- */
    body {
      font-family: Arial, Helvetica, sans-serif;
      margin: 20px;
      background-color: #f4f4f9;
      color: #333;
    }

    /* --- Barra superior con logo y bot√≥n --- */
    #top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      flex-wrap: wrap;
      gap: 10px;
    }
    #top-bar h2 {
      margin: 0;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #top-bar h2 img {
      height: 35px;
    }
    #top-bar button {
      padding: 10px 18px;
      font-size: 15px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      background: #0078ff;
      color: white;
      cursor: pointer;
    }
    #top-bar button:hover { background: #005ec5; }

    /* --- Contenedor principal --- */
    #main-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      max-width: 1500px;
      margin: 0 auto;
    }

    /* --- Mapa --- */
    #map-container {
      flex: 1;
      min-width: 600px;
      height: 85vh;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    #map {
      width: 100%;
      height: 100%;
      border-radius: 12px;
    }

    /* --- Glosario lateral --- */
    #legend {
      width: 250px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      font-size: 14px;
    }
    .legend-title {
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 16px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .legend-icon {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      border-radius: 50%;
      border: 1px solid #ccc;
    }
    .legend-item i {
      font-size: 16px;
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }

    /* --- Bot√≥n deshacer --- */
    #undoBtn {
      display: block;
      margin: 15px auto 0 auto;
      padding: 10px 18px;
      font-size: 15px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      background: #6c757d;
      color: white;
      cursor: pointer;
      width: 100%;
    }
    #undoBtn:hover { background: #5a6268; }

    /* --- Formularios en popup --- */
    .popup-form label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    .popup-form input,
    .popup-form select {
      width: 95%;
      padding: 8px;
      margin-top: 4px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    .popup-buttons {
      margin-top: 15px;
      display: flex;
      justify-content: space-between;
    }
    .popup-buttons button {
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
    }
    .save-btn { background-color: #28a745; }
    .delete-btn { background-color: #dc3545; }

    /* --- Iconos personalizados para marcadores --- */
    .custom-marker-container {
      text-align: center;
      position: relative;
      width: 150px;
      left: -75px;
    }
    .marker-label {
      background: rgba(255, 255, 255, 0.85);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      white-space: nowrap;
      position: absolute;
      bottom: 45px;
      left: 50%;
      transform: translateX(-50%);
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .marker-icon-background {
      width: 32px;
      height: 32px;
      border-radius: 50% 50% 50% 0;
      transform: rotate(-45deg);
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      margin: 0 auto;
    }
    .marker-icon-background i {
      transform: rotate(45deg);
      font-size: 16px;
      color: white;
    }

    /* --- Responsivo --- */
    @media (max-width: 900px) {
      #main-container { flex-direction: column; }
      #legend { width: 100%; }
    }
  </style>
</head>
<body>

  <!-- Barra superior con logo y bot√≥n -->
  <header id="top-bar">
    <h2>
      <img src="a41eb642-d670-466b-b8e3-6817f44ae436.png" alt="Defensa Civil">
      Mapa Interactivo de Yerba Buena Defensa Civil
    </h2>
    <button id="addMarkerBtn">‚ûï Agregar Marcador</button>
  </header>
  
  <!-- Contenido principal -->
  <div id="main-container">
    <!-- Mapa -->
    <div id="map-container"><div id="map"></div></div>

    <!-- Glosario -->
    <aside id="legend">
      <div class="legend-title">Plan de Evacuaci√≥n</div>
      <div class="legend-item"><div class="legend-icon" style="background: #007bff;"></div>Tiene</div>
      <div class="legend-item"><div class="legend-icon" style="background: #dc3545;"></div>No tiene</div>
      <div class="legend-item"><div class="legend-icon" style="background: #28a745;"></div>A verificar</div>
      <div class="legend-item"><div class="legend-icon" style="background: #ffc107;"></div>Falta solicitar</div>
      <hr>
      <div class="legend-title">Tipos de Lugar</div>
      <div class="legend-item"><i class="fa-solid fa-graduation-cap"></i> Escuela</div>
      <div class="legend-item"><i class="fa-solid fa-cake-candles"></i> Sal√≥n de Fiestas</div>
      <div class="legend-item"><i class="fa-solid fa-child-reaching"></i> Sal√≥n Infantil</div>
      <button id="undoBtn">‚Ü©Ô∏è Deshacer Cambios</button>
    </aside>
  </div>

  <!-- Scripts Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    /* --- MAPA --- */
    const map = L.map('map').setView([-26.819, -65.305], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors',
      noWrap: true,
      bounds: [[-90, -180], [90, 180]]
    }).addTo(map);
    map.setMaxBounds([[-90, -180], [90, 180]]);

    /* --- CAPA DE MARCADORES Y ESTADO --- */
    const markersLayer = L.layerGroup().addTo(map);
    let markers = {};           // marcadores activos
    let savedState = [];        // estado para deshacer

    /* --- Colores y tipos de iconos --- */
    const statusColors = {
      blue: '#007bff', red: '#dc3545', green: '#28a745', gold: '#ffc107'
    };
    const placeIconsHTML = {
      escuela: '<i class="fa-solid fa-graduation-cap"></i>',
      salon:   '<i class="fa-solid fa-cake-candles"></i>',
      infantil:'<i class="fa-solid fa-child-reaching"></i>'
    };

    /* --- Crear icono personalizado --- */
    function createCustomIcon(data) {
      return L.divIcon({
        html: `
          <div class="custom-marker-container">
            <div class="marker-label">${data.name}</div>
            <div class="marker-icon-background" style="background-color: ${statusColors[data.color] || '#888'};">
              ${placeIconsHTML[data.type] || ''}
            </div>
          </div>
        `,
        className: '',
        iconAnchor: [0, 16]
      });
    }

    /* --- Popup editable --- */
    function createPopupContent(markerId, data) {
      return `
        <div class="popup-form">
          <label for="name-${markerId}">Nombre:</label>
          <input type="text" id="name-${markerId}" value="${data.name}">
          <label for="address-${markerId}">Direcci√≥n:</label>
          <input type="text" id="address-${markerId}" value="${data.address}">
          <label for="type-${markerId}">Tipo de lugar:</label>
          <select id="type-${markerId}">
            <option value="escuela" ${data.type === 'escuela' ? 'selected' : ''}>üéì Escuela</option>
            <option value="salon" ${data.type === 'salon' ? 'selected' : ''}>üéâ Sal√≥n de Fiestas</option>
            <option value="infantil" ${data.type === 'infantil' ? 'selected' : ''}>üß∏ Sal√≥n Infantil</option>
          </select>
          <label for="color-${markerId}">Estado del Plan:</label>
          <select id="color-${markerId}"> 
            <option value="blue" ${data.color === 'blue' ? 'selected' : ''}>Tiene</option>
            <option value="red" ${data.color === 'red' ? 'selected' : ''}>No tiene</option>
            <option value="green" ${data.color === 'green' ? 'selected' : ''}>A verificar</option>
            <option value="gold" ${data.color === 'gold' ? 'selected' : ''}>Falta solicitar</option>
          </select>
          <div class="popup-buttons">
            <button class="save-btn" onclick="saveMarker('${markerId}')">Guardar</button>
            <button class="delete-btn" onclick="deleteMarker('${markerId}')">Eliminar</button>
          </div>
        </div>
      `;
    }

    /* --- Agregar marcador --- */
    function addMarker(latlng, data) {
      const markerId = `marker_${Date.now()}_${Math.floor(Math.random()*1000)}`;
      const marker = L.marker(latlng, {
        icon: createCustomIcon(data),
        draggable: true
      }).addTo(markersLayer);

      marker.markerId = markerId;
      marker.customData = {...data};
      markers[markerId] = marker;

      marker.bindPopup(createPopupContent(markerId, data));
      return markerId;
    }

    /* --- Guardar cambios --- */
    window.saveMarker = function(markerId) {
      const marker = markers[markerId];
      if (!marker) return;
      const newData = {
        name: document.getElementById(`name-${markerId}`).value,
        address: document.getElementById(`address-${markerId}`).value,
        type: document.getElementById(`type-${markerId}`).value,
        color: document.getElementById(`color-${markerId}`).value
      };
      marker.customData = newData;
      marker.setIcon(createCustomIcon(newData));
      marker.setPopupContent(createPopupContent(markerId, newData));
      marker.closePopup();
    }

    /* --- Eliminar marcador --- */
    window.deleteMarker = function(markerId) {
      if (confirm('¬øEliminar este marcador?')) {
        const marker = markers[markerId];
        if (marker) {
          markersLayer.removeLayer(marker);
          delete markers[markerId];
        }
      }
    }

    /* --- Bot√≥n agregar marcador --- */
    document.getElementById("addMarkerBtn").addEventListener("click", function() {
      addMarker(map.getCenter(), {
        name: 'Nuevo Lugar',
        address: 'Direcci√≥n pendiente',
        type: 'salon',
        color: 'gold'
      });
    });

    /* --- Guardar estado actual --- */
    function saveState() {
      savedState = Object.values(markers).map(marker => ({
        latlng: marker.getLatLng(),
        data: {...marker.customData}
      }));
    }

    /* --- Restaurar estado (deshacer) --- */
    document.getElementById("undoBtn").addEventListener("click", function() {
      if (savedState.length === 0) return;
      markersLayer.clearLayers();
      markers = {};
      savedState.forEach(m => addMarker(m.latlng, m.data));
    });

    /* --- Marcadores iniciales --- */
    const initialMarkers = [
      { latlng: [-26.814, -65.311], data: { name: 'Colegio del Sol', address: 'Av. Aconquija 123', type: 'escuela', color: 'blue' } },
      { latlng: [-26.818, -65.295], data: { name: 'Eventos La Casona', address: 'Lobo de la Vega 789', type: 'salon', color: 'red' } }
    ];
    initialMarkers.forEach(m => addMarker(m.latlng, m.data));
    saveState(); // guarda el estado inicial
  </script>
</body>
</html>
