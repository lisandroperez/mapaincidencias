<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Plan Evacuacion DC YB</title>
    <!-- Incluir la librer√≠a Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* Estilos generales para un dise√±o limpio y moderno */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f0f0;
            min-height: 100vh;
        }

        h2 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: #333;
        }

        #map-container {
            position: relative;
            width: 100%;
            max-width: 1200px;
            height: 80vh;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: 12px;
        }

        #controls {
            margin: 10px 0;
            display: flex;
            justify-content: center;
        }

        #controls button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 25px;
            background-color: #0078FF;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #controls button:hover {
            background-color: #005ec5;
            transform: translateY(-2px);
        }

        /* Estilos para el toast (notificaci√≥n) */
        #toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 2000;
        }

        #toast.show {
            opacity: 1;
        }
        
        .popup-buttons-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .popup-buttons-container button {
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: transform 0.1s;
        }
        
        .popup-buttons-container button:hover {
             transform: translateY(-1px);
        }

        /* Estilos para la leyenda */
        #legend {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            font-size: 14px;
            line-height: 20px;
            position: absolute;
            bottom: 15px;
            right: 15px;
            z-index: 1000;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-icon {
            width: 22px;
            height: 22px;
            margin-right: 8px;
            border-radius: 50%;
            border: 2px solid white;
        }

        /* Estilos para la etiqueta de t√≠tulo del marcador */
        .marker-label {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            background: rgba(255, 255, 255, 0.8);
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .leaflet-marker-icon .custom-pin {
            position: relative; /* Necesario para el posicionamiento del label */
        }
        
    </style>
</head>
<body>
    <h2>Mapa Plan Evacuacion DC YB</h2>
    <div id="controls">
        <button id="addMarkerBtn">‚ûï Agregar marcador</button>
    </div>
    <div id="map-container">
        <div id="map"></div>
    </div>
    <div id="toast"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- UI Helpers ---
            const toast = (message) => {
                const toastEl = document.getElementById('toast');
                toastEl.textContent = message;
                toastEl.classList.add('show');
                setTimeout(() => {
                    toastEl.classList.remove('show');
                }, 2000);
            };

            // --- Inicializar mapa ---
            const map = L.map('map').setView([-26.816, -65.216], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // --- Almac√©n de datos y marcadores ---
            const markersData = new Map();
            const markers = new Map();
            let nextMarkerId = 1;

            // --- Colores y tipos de √≠conos ---
            const COLOR_MAP = {
                'Tiene': 'blue',
                'No tiene': 'red',
                'A verificar': 'green',
                'Falta solicitar': 'gold'
            };
            
            const TYPE_MAP = {
                'escuela': 'üéì',
                'salon': 'üéâ',
                'infantil': 'üß∏'
            };

            // Funci√≥n para crear un icono de marcador con etiqueta
            const customIcon = (data) => {
                const color = COLOR_MAP[data.state] || 'blue';
                const emoji = TYPE_MAP[data.type] || 'üìç';
                return L.divIcon({
                    className: "custom-pin",
                    html: `
                        <div style='position:relative;width:30px;height:30px;'>
                            <div class="marker-label">${data.name}</div>
                            <div style='background:${color};width:30px;height:30px;border-radius:50%;border:2px solid white;display:flex;align-items:center;justify-content:center;font-size:18px;'>${emoji}</div>
                        </div>
                    `,
                    iconSize: [30, 30],
                    iconAnchor: [15, 45] // Ajustado para centrar el icono y la etiqueta
                });
            };

            // --- Funci√≥n para crear el contenido del popup de vista ---
            function createViewPopupContent(data) {
                const contentDiv = document.createElement('div');
                
                contentDiv.innerHTML = `
                    <div style="font-family: inherit; font-size: 14px;">
                        <h4><b>${data.name}</b></h4>
                        <p>Tipo: ${data.type}</p>
                        <p>Estado: ${data.state}</p>
                        <p>Direcci√≥n: ${data.address || 'No especificada'}</p>
                        <div class="popup-buttons-container">
                            <button id="editBtn" style="background-color: #fca5a5; color: black;">‚úèÔ∏è Editar</button>
                            <button id="deleteBtn" style="background-color: #ef4444; color: white;">üóëÔ∏è Eliminar</button>
                        </div>
                    </div>
                `;

                contentDiv.querySelector('#editBtn').addEventListener('click', () => editMarker(data.id));
                contentDiv.querySelector('#deleteBtn').addEventListener('click', () => deleteMarker(data.id));

                return contentDiv;
            }

            // --- Funci√≥n para crear el contenido del popup de edici√≥n ---
            function createEditPopupContent(data) {
                const contentDiv = document.createElement('div');
                contentDiv.innerHTML = `
                    <div style="font-family: inherit; font-size: 14px; padding: 5px;">
                        <h4><b>Editar marcador</b></h4>
                        <label style="display: block; margin-bottom: 8px;">
                            Nombre: <input id="nameInput" value="${data.name}" style="width: 100%; box-sizing: border-box; padding: 5px; border-radius: 4px; border: 1px solid #ccc;"/>
                        </label>
                        <label style="display: block; margin-bottom: 8px;">
                            Tipo: 
                            <select id="typeSelect" style="width: 100%; box-sizing: border-box; padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                                <option value="escuela" ${data.type==="escuela"?"selected":""}>Escuela</option>
                                <option value="salon" ${data.type==="salon"?"selected":""}>Sal√≥n de fiestas</option>
                                <option value="infantil" ${data.type==="infantil"?"selected":""}>Sal√≥n infantil</option>
                            </select>
                        </label>
                        <label style="display: block; margin-bottom: 8px;">
                            Estado: 
                            <select id="stateSelect" style="width: 100%; box-sizing: border-box; padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                                <option value="Tiene" ${data.state==="Tiene"?"selected":""}>Tiene</option>
                                <option value="No tiene" ${data.state==="No tiene"?"selected":""}>No tiene</option>
                                <option value="A verificar" ${data.state==="A verificar"?"selected":""}>A verificar</option>
                                <option value="Falta solicitar" ${data.state==="Falta solicitar"?"selected":""}>Falta solicitar</option>
                            </select>
                        </label>
                        <label style="display: block; margin-bottom: 8px;">
                            Direcci√≥n: <input id="addressInput" value="${data.address || ''}" style="width: 100%; box-sizing: border-box; padding: 5px; border-radius: 4px; border: 1px solid #ccc;"/>
                        </label>
                        <div style="margin-top: 10px;">
                            <button id="saveBtn" style="background-color: #22c55e; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;">üíæ Guardar</button>
                        </div>
                    </div>
                `;

                contentDiv.querySelector('#saveBtn').addEventListener('click', () => {
                    const newName = contentDiv.querySelector('#nameInput').value;
                    const newType = contentDiv.querySelector('#typeSelect').value;
                    const newState = contentDiv.querySelector('#stateSelect').value;
                    const newAddress = contentDiv.querySelector('#addressInput').value;
                    
                    data.name = newName || 'Nuevo Marcador';
                    data.type = newType;
                    data.state = newState;
                    data.address = newAddress;
                    
                    // El marcador no se mueve al guardar. Su posici√≥n es determinada por el usuario al arrastrarlo.
                    addOrUpdateOnMap(data);
                    markers.get(data.id).closePopup();
                    toast("¬°Marcador guardado!");
                });
                
                return contentDiv;
            }
            
            // --- Funci√≥n principal para agregar/actualizar marcadores ---
            function addOrUpdateOnMap(data, openEdit = false) {
                let marker = markers.get(data.id);
                if (!marker) {
                    marker = L.marker([data.lat, data.lng], {
                        icon: customIcon(data),
                        draggable: true
                    }).addTo(map);

                    marker.on("dragend", (e) => {
                        const ll = e.target.getLatLng();
                        data.lat = ll.lat;
                        data.lng = ll.lng;
                        // Vuelve a enlazar el popup para reflejar la direcci√≥n actualizada, si la hay.
                        marker.bindPopup(createViewPopupContent(data));
                        markersData.set(data.id, data);
                    });
                    
                    markers.set(data.id, marker);
                } else {
                    marker.setIcon(customIcon(data));
                    marker.setLatLng([data.lat, data.lng]);
                }
                
                markersData.set(data.id, data);
                marker.bindPopup(openEdit ? createEditPopupContent(data) : createViewPopupContent(data));
                
                if (openEdit) {
                    marker.openPopup();
                }
            }

            // --- Funciones de edici√≥n (accesibles globalmente) ---
            window.editMarker = function(id) {
                const data = markersData.get(id);
                if (data) addOrUpdateOnMap(data, true);
            };

            window.deleteMarker = function(id) {
                const marker = markers.get(id);
                if (!marker) return;
                map.removeLayer(marker);
                markers.delete(id);
                markersData.delete(id);
                toast("Marcador eliminado.");
            };
            
            // --- Bot√≥n para agregar marcador en el centro ---
            document.getElementById("addMarkerBtn").addEventListener("click", function(){
                const center = map.getCenter();
                const newMarkerData = {
                    id: `temp-${nextMarkerId++}`,
                    name: "Nuevo marcador",
                    type: "escuela",
                    state: "Tiene",
                    address: "",
                    lat: center.lat,
                    lng: center.lng
                };
                addOrUpdateOnMap(newMarkerData, true);
            });

            // --- Marcadores iniciales ---
            const initialMarkers = [
                {id: "1", name:"Escuela Rep√∫blica de Italia", type:"escuela", state:"Tiene", address:"Escuela Rep√∫blica de Italia, Av. Belgrano 3450", lat:-26.82, lng:-65.22},
                {id: "2", name:"Escuela San Agust√≠n", type:"escuela", state:"A verificar", address:"Escuela San Agust√≠n, Av. Roca 123", lat:-26.819, lng:-65.215},
                {id: "3", name:"Sal√≥n de Fiestas", type:"salon", state:"No tiene", address:"Sal√≥n de Fiestas, Viamonte 789", lat:-26.817, lng:-65.213},
                {id: "4", name:"Sal√≥n Infantil", type:"infantil", state:"Falta solicitar", address:"Sal√≥n Infantil, Av. Sarmiento 1011", lat:-26.815, lng:-65.211}
            ];

            initialMarkers.forEach(markerData => addOrUpdateOnMap(markerData));

            // --- Leyenda ---
            const legend = L.control({position: 'bottomright'});
            legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'info legend');
                div.innerHTML = `
                    <div id="legend">
                        <strong>Glosario</strong>
                        <div class="legend-item"><div class="legend-icon" style="background:${COLOR_MAP['Tiene']};"></div>Plan de evacuaci√≥n: Tiene</div>
                        <div class="legend-item"><div class="legend-icon" style="background:${COLOR_MAP['No tiene']};"></div>Plan de evacuaci√≥n: No tiene</div>
                        <div class="legend-item"><div class="legend-icon" style="background:${COLOR_MAP['A verificar']};"></div>Plan de evacuaci√≥n: A verificar</div>
                        <div class="legend-item"><div class="legend-icon" style="background:${COLOR_MAP['Falta solicitar']};"></div>Plan de evacuaci√≥n: Falta solicitar</div>
                        <div class="legend-item">üéì Escuela</div>
                        <div class="legend-item">üéâ Sal√≥n de Fiestas</div>
                        <div class="legend-item">üß∏ Sal√≥n Infantil</div>
                    </div>
                `;
                return div;
            };
            legend.addTo(map);

        });
    </script>
</body>
</html>

</body>
</html>


